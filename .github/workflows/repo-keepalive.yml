name: Repo Keepalive (weekly)

on:
  schedule:
    - cron: "0 3 * * 0"   # wÃ¶chentlich, So 03:00 UTC
  workflow_dispatch: {}

permissions:
  issues: write
  contents: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  keepalive:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GH_TOKEN: ${{ github.token }}  # gh CLI nutzt dieses Token automatisch
    steps:
      - name: Prepare timestamp
        shell: bash
        run: |
          set -euo pipefail
          echo "DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_ENV"

      - name: Keepalive
        shell: bash
        run: |
          set -euo pipefail

          retry() {
            local max="$1"; shift
            local n=1 delay=2
            until "$@"; do
              if [ "$n" -ge "$max" ]; then
                echo "Command failed after ${n} attempts." >&2
                return 1
              fi
              sleep "$delay"
              n=$((n+1))
              delay=$((delay*2))
            done
          }

          # 1) Offene Issue mit Titel 'keepalive' suchen (JSON-Ausgabe, Nummer extrahieren)
          ISSUE_NUMBER="$(retry 3 gh issue list \
            --repo "$GITHUB_REPOSITORY" \
            --search 'keepalive in:title is:open' \
            --json number --jq '.[0].number // empty' || true)"

          # 2) Falls nicht vorhanden: erzeugen und Issue-Nummer aus ausgegebener URL extrahieren
          if [ -z "${ISSUE_NUMBER:-}" ]; then
            CREATE_OUT="$(retry 3 gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "keepalive" \
              --body "Automatisch erstellt, um Repository-Aktivitaet sicherzustellen.")"
            # Erwartete Ausgabe: https://github.com/<owner>/<repo>/issues/<nr>
            ISSUE_NUMBER="$(printf '%s\n' "$CREATE_OUT" | sed -E 's#.*/issues/([0-9]+).*#\1#')"
          fi

          if [ -z "${ISSUE_NUMBER:-}" ]; then
            echo "Could not determine issue number." >&2
            exit 1
          fi

          BODY="Keepalive-Ping: ${DATE} (run: ${GITHUB_RUN_ID})"

          # 3) Kommentar posten
          retry 3 gh issue comment "$ISSUE_NUMBER" \
            --repo "$GITHUB_REPOSITORY" \
            --body "$BODY"

      - name: Determine default branch
        id: default_branch
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          default_branch=$(gh repo view "$GITHUB_REPOSITORY" --json defaultBranchRef --jq '.defaultBranchRef.name')

          if [ -z "${default_branch:-}" ]; then
            echo "Could not determine default branch" >&2
            exit 1
          fi

          echo "Resolved default branch: ${default_branch}"
          echo "name=${default_branch}" >> "$GITHUB_OUTPUT"

      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.default_branch.outputs.name }}
          fetch-depth: 2

      - name: Create empty keepalive commit if repository is quiet
        shell: bash
        env:
          DEFAULT_BRANCH: ${{ steps.default_branch.outputs.name }}
        run: |
          set -euo pipefail

          git fetch --prune origin "$DEFAULT_BRANCH"
          git checkout "$DEFAULT_BRANCH"

          last_commit_ts=$(git log -1 --format=%ct origin/"$DEFAULT_BRANCH")
          now=$(date +%s)
          days_since=$(( (now - last_commit_ts) / 86400 ))

          if [ "$days_since" -lt 45 ]; then
            echo "Last commit is ${days_since} days old; no keepalive commit needed."
            exit 0
          fi

          echo "Creating keepalive empty commit (last commit ${days_since} days ago)."
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit --allow-empty -m "chore: keepalive (${DATE})"
          git push origin HEAD:"${DEFAULT_BRANCH}"
